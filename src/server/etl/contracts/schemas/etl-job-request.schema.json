{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "etl-job-request@v1",
  "title": "ETL Job Request",
  "description": "Schema for ETL job requests between Node/TypeScript orchestration and Python ETL workers",
  "type": "object",
  "required": ["schemaVersion", "runId", "createdAt", "input", "models", "output"],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "enum": ["etl-job@v1"],
      "description": "Schema version identifier"
    },
    "runId": {
      "type": "string",
      "minLength": 1,
      "description": "Run ID (MongoDB ObjectId string)"
    },
    "createdAt": {
      "type": "string",
      "format": "date-time",
      "description": "Creation timestamp (ISO 8601)"
    },
    "input": {
      "type": "object",
      "required": ["includeChunks", "includeExtensions", "geoSource"],
      "properties": {
        "documentIds": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "Document IDs to process (mutually exclusive with query)"
        },
        "query": {
          "type": "object",
          "additionalProperties": true,
          "description": "Query filters (mutually exclusive with documentIds)"
        },
        "includeChunks": {
          "type": "boolean",
          "description": "Whether to include chunks in processing"
        },
        "includeExtensions": {
          "type": "object",
          "required": ["geo", "legal", "web"],
          "properties": {
            "geo": {
              "type": "boolean"
            },
            "legal": {
              "type": "boolean"
            },
            "web": {
              "type": "boolean"
            }
          }
        },
        "geoSource": {
          "type": "string",
          "enum": ["mongo", "postgis", "both"],
          "description": "Geo data source"
        }
      },
      "oneOf": [
        {
          "required": ["documentIds"]
        },
        {
          "required": ["query"]
        }
      ]
    },
    "artifacts": {
      "type": "object",
      "properties": {
        "artifactRefs": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-f0-9]{64}$",
            "description": "ArtifactRef.sha256"
          },
          "description": "Optional artifact references for traceability"
        }
      }
    },
    "models": {
      "type": "object",
      "required": ["nlpModelId", "rdfMappingVersion"],
      "properties": {
        "nlpModelId": {
          "type": "string",
          "minLength": 1,
          "description": "NLP model identifier (e.g., 'spacy-nl@v3.7.0')"
        },
        "rdfMappingVersion": {
          "type": "string",
          "minLength": 1,
          "description": "RDF mapping version (e.g., 'rdf-mapping@v1.0.0')"
        }
      }
    },
    "output": {
      "type": "object",
      "required": ["format", "manifestName"],
      "properties": {
        "format": {
          "type": "string",
          "enum": ["turtle"],
          "description": "Output format (currently only 'turtle')"
        },
        "outputDir": {
          "type": "string",
          "minLength": 1,
          "description": "Output directory path (mutually exclusive with artifactStorePrefix)"
        },
        "artifactStorePrefix": {
          "type": "string",
          "minLength": 1,
          "description": "Artifact store prefix (mutually exclusive with outputDir)"
        },
        "manifestName": {
          "type": "string",
          "minLength": 1,
          "description": "Manifest filename (e.g., 'manifest.json')"
        }
      },
      "oneOf": [
        {
          "required": ["outputDir"]
        },
        {
          "required": ["artifactStorePrefix"]
        }
      ]
    }
  }
}

